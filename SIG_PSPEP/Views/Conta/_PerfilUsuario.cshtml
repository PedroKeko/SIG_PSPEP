@model SIG_PSPEP.Models.PerfilUsuarioViewModel
@using SIG_PSPEP.Entidades
@{
    ViewData["Title"] = "Perfil do Usuário";
    var efectivo = ViewBag.Efectivo as Efectivo;
    var area = ViewBag.Area as Area;
    var roles = ViewBag.Roles as List<string>;
    var claims = ViewBag.Claims as List<string>;
    string GetFotoBase64() => Model.Foto != null ? $"data:image/jpeg;base64,{Convert.ToBase64String(Model.Foto)}" : "~/assets/img/user.png";
}
<link href="~/dist/css/mystyle.css" rel="stylesheet" />
<link href="~/dist/css/botoes.css" rel="stylesheet" />
<div class="modal-header">
    <h5 class="modal-title">Perfil do Usuário</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
</div>
<!-- Modal Body (conteúdo dinâmico será injetado aqui) -->
<div class="modal-body">
    <div class="card mb-4 shadow-sm">
        <div class="d-flex justify-content-end">
            <button type="button" class="custom2-btn btn-2-red" data-bs-toggle="modal" data-bs-target="#alterarSenhaModal">
                Alterar Senha
            </button>
        </div>
        <div class="card-body d-flex flex-column flex-md-row gap-4">
            <div>
                <img src="@GetFotoBase64()" class="img-thumbnail rounded-circle mb-3"
                     style="width: 180px; height: 180px; object-fit: cover;" alt="Foto do Efetivo" />
            </div>
            <div class="flex-fill">
                <h5>@Model.NomeCompleto</h5>
                <p class="mb-1"><strong>Email:</strong> @Model.Email</p>
                <p class="mb-1"><strong>Telefone:</strong> @Model.PhoneNumber</p>
                <p class="mb-1"><strong>Função:</strong> @efectivo?.FuncaoCargo?.NomeFuncaoCargo</p>
                <p class="mb-1"><strong>Patente:</strong> @efectivo?.Patente?.Classe</p>
                <p class="mb-1"><strong>Posto:</strong> @efectivo?.Patente?.Posto</p>
                <p class="mb-1"><strong>Unidade:</strong> @efectivo?.OrgaoUnidade?.NomeOrgaoUnidade</p>
                <p class="mb-1"><strong>Área:</strong> @area?.NomeArea</p>
                <p class="mb-1"><strong>Função:</strong> @string.Join(", ", Model.Roles ?? new List<string>())</p>

                <p class="mb-1"><strong>Permissões (Claims):</strong></p>
                <ul>
                    @foreach (var claim in claims ?? new List<string>())
                    {
                        <li>@claim</li>
                    }
                </ul>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Dados do Efetivo</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>NIP:</strong> @efectivo?.NIP</p>
                    <p><strong>Nº Processo:</strong> @efectivo?.Num_Processo</p>
                    <p><strong>Gênero:</strong> @efectivo?.Genero</p>
                    <p><strong>Data de Nascimento:</strong> @efectivo?.DataNasc.ToShortDateString()</p>
                    <p><strong>Estado Civil:</strong> @efectivo?.EstadoCivil</p>
                </div>
                <div class="col-md-6">
                    <p><strong>BI:</strong> @efectivo?.NumBI</p>
                    <p><strong>Validade do BI:</strong> @efectivo?.BIValidade.ToShortDateString()</p>
                    <p><strong>Nacionalidade:</strong> @efectivo?.Nacionalidade</p>
                    <p><strong>Telefone:</strong> @efectivo?.Telefone1</p>
                    <p><strong>Email:</strong> @efectivo?.Email</p>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal de Alteração de Senha -->
<div class="modal fade" id="alterarSenhaModal" tabindex="-1" aria-labelledby="alterarSenhaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formAlterarSenha" asp-action="AlterarSenha" asp-controller="Conta" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="alterarSenhaModalLabel">Alterar Senha</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="row justify-content-center">
                        <div class="col-md-9">
                            <div class="mb-3">
                                <label class="control-label small-label">Senha Actual</label>
                                <input asp-for="CurrentPassword" class="form-control form-control-sm input-1 small-input" />
                                <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label class="control-label small-label">Nova Senha</label>
                                <input asp-for="NewPassword" class="form-control form-control-sm input-1 small-input" />
                                <span asp-validation-for="NewPassword" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label class="control-label small-label">Confirmar Nova Senha</label>
                                <input asp-for="ConfirmNewPassword" class="form-control form-control-sm input-1 small-input" />
                                <span asp-validation-for="ConfirmNewPassword" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="custom2-btn btn-2-success">Atualizar</button>
                    <button type="button" class="custom2-btn btn-2-dark-blue" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}

<script src="~/dist/js/sweetalert2@11.js"></script>

<script>

    // Abrir modal quando a senha atual estiver inválida
    $(document).ready(function () {
        const senhaInvalida = '@ViewData["SenhaInvalida"]';
        if (senhaInvalida === 'true') {
            var alterarModal = new bootstrap.Modal(document.getElementById('alterarSenhaModal'), {
                backdrop: 'static',
                keyboard: false
            });
            alterarModal.show();
        }
    });

    // Instância padrão do Toast
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 1500,
        timerProgressBar: true,
        customClass: {
            popup: 'colored-toast'
        },
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer)
            toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
    });

    $(document).ready(function () {

        // 🔥 NECESSÁRIO: Enviar AntiForgeryToken no header
        var token = $('input[name="__RequestVerificationToken"]').val();
        $.ajaxSetup({
            headers: {
                "RequestVerificationToken": token
            }
        });

        // Submeter form via AJAX
        $("#formAlterarSenha").on("submit", function (e) {
            e.preventDefault();

            const form = $(this);
            const url = form.attr("action");
            const data = form.serialize();

            $.ajax({
                type: "POST",
                url: url,
                data: data,
                success: function (response) {

                    if (response.success) {
                        Toast.fire({
                            icon: 'success',
                            title: response.message
                        });

                        // Redireciona após o toast
                        setTimeout(function () {
                            window.location.href = '/Conta/Login';
                        }, 1600);
                    }
                    else if (response.errors) {
                        Toast.fire({
                            icon: 'error',
                            title: response.errors.join("<br>")
                        });
                    }
                },
                error: function () {
                    Toast.fire({
                        icon: 'error',
                        title: 'Erro ao processar a solicitação.'
                    });
                }
            });
        });
    });

</script>
