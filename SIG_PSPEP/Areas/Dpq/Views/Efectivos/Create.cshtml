@model SIG_PSPEP.Models.EfectivoViewModel

@{
    ViewData["Title"] = "Create";
    Layout = null;
}

<div class="alert alert-danger d-none" id="alert-errors"></div>

<form asp-action="Create" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <div class="formbold-steps">
        <ul>
            <li class="formbold-step-menu1 active">
                <span>1</span>
                Pessoais
            </li>
            <li class="formbold-step-menu2">
                <span>2</span>
                Policiais
            </li>
            <li class="formbold-step-menu3">
                <span>3</span>
                Acadêmico
            </li>
            <li class="formbold-step-menu4">
                <span>4</span>
                Documentos
            </li>
            <li class="formbold-step-menu5">
                <span>5</span>
                Contactos
            </li>
        </ul>
    </div>

    <!-- 1 Pessoais -->
    <div class="formbold-form-step-1 active">
        <div class="row">
            <div class="col-12 col-md-3 perfil-container">
                <div class="perfil-wrapper">
                    <!-- Título acima da imagem -->
                    <label class="perfil-label">Carregar Foto</label>
                    <!-- Imagem de perfil -->
                    <img id="profileImage"
                         src="~/assets/images/users/user-police.png"
                         class="perfil-img"
                         alt="Foto de Perfil" />

                    <!-- Botão de upload -->
                    <label for="imageUpload" class="perfil-edit-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </label>

                    <!-- Input escondido -->
                    <input type="file" id="imageUpload" name="FotoIF" accept="image/*" style="display: none;" onchange="previewImage(event)" />
                </div>
            </div>


            <div class="col-12 col-md-9">
                <div class="row">
                    <div class="col-12 col-md-8">
                        <!-- Nome Completo -->
                        <div class="form-group">
                            <label asp-for="NomeCompleto" class="control-label small-label"></label>
                            <input asp-for="NomeCompleto" class="form-control form-control-sm input-1 small-input" placeholder="Nome Completo" required
                                   oninvalid="this.setCustomValidity('Por favor, preencha o nome do Efectivo!')" oninput="setCustomValidity('')" />
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <!-- Apelido -->
                        <div class="form-group">
                            <label asp-for="Apelido" class="control-label small-label"></label>
                            <input asp-for="Apelido" class="form-control form-control-sm input-1 small-input" placeholder="Apelido" required />
                            <span asp-validation-for="Apelido" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 col-md-4">
                        <!-- Gênero -->
                        <div class="form-group">
                            <label asp-for="Genero" class="control-label small-label"></label>
                            <select asp-for="Genero" class="form-select form-control-sm input-1 small-input">
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                            </select>
                            <span asp-validation-for="Genero" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <!-- Estado Cívil -->
                        <div class="form-group">
                            <label asp-for="EstadoCivil" class="control-label small-label"></label>
                            <select asp-for="EstadoCivil" class="form-select form-control-sm input-1 small-input">
                                <option value="Solteiro">Solteiro</option>
                                <option value="Casado">Casado</option>
                                <option value="Divorciado">Divorciado</option>
                                <option value="Viuvo">Viuvo</option>
                            </select>
                            <span asp-validation-for="EstadoCivil" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="form-group">
                            <label class="control-label small-label">Grupo Sanguíneo</label>
                            <select asp-for="GSanguineo" class="form-select form-control-sm input-1 small-input">
                                <option value="A+">A positivo</option>
                                <option value="A-">A negativo</option>
                                <option value="B+">B positivo</option>
                                <option value="B-">B negativo</option>
                                <option value="AB+">AB positivo</option>
                                <option value="AB-">AB negativo</option>
                                <option value="O+">O positivo</option>
                                <option value="O-">O negativo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 col-md-4">
                        <!-- Data de Nascimento -->
                        <div class="form-group">
                            <label asp-for="DataNasc" class="control-label small-label"></label>
                            <input asp-for="DataNasc" class="form-control form-control-sm input-1 small-input" type="date" />
                            <span asp-validation-for="DataNasc" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="form-group">
                            <label class="control-label small-label">Nacionalidade</label>
                            <select class="form-select form-control-sm input-1 small-input">
                                <option value="Nacionalidade">Angolana</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="form-group">
                            <label asp-for="ProvinciaNascId" class="control-label small-label"></label>
                            <select asp-for="ProvinciaNascId" class="form-select form-control-sm input-1 small-input" asp-items="ViewBag.ProvinciaNascId"></select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2 Policiais -->
    <div class="formbold-form-step-2">
        <div class="row">

            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="Num_Processo" class="control-label small-label"></label>
                    <input asp-for="Num_Processo" class="form-control form-control-sm input-1 small-input" placeholder="Número do Processo" />
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="NIP" class="control-label small-label"></label>
                    <input asp-for="NIP" class="form-control form-control-sm input-1 small-input" placeholder="NIP" required
                           oninvalid="this.setCustomValidity('Por favor, preencha o NIP do Efectivo!')" oninput="setCustomValidity('')" />
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="N_Agente" class="control-label small-label"></label>
                    <input asp-for="N_Agente" class="form-control form-control-sm input-1 small-input" placeholder="Número de Agente" required
                           oninvalid="this.setCustomValidity('Por favor, preencha o número de Agente!')" oninput="setCustomValidity('')" />
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="PatenteId" class="control-label small-label"></label>
                    <select asp-for="PatenteId" class="form-select form-control-sm input-1 small-input" asp-items="ViewBag.PatenteId"></select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="OrgaoUnidadeId" class="control-label small-label"></label>
                    <select asp-for="OrgaoUnidadeId" class="form-select form-control-sm input-1 small-input" asp-items="ViewBag.OrgaoUnidadeId"></select>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="FuncaoCargoId" class="control-label small-label"></label>
                    <select asp-for="FuncaoCargoId" class="form-select form-control-sm input-1 small-input" asp-items="ViewBag.FuncaoCargoId"></select>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="SituacaoEfectivoId" class="control-label small-label"></label>
                    <select asp-for="SituacaoEfectivoId" class="form-select form-control-sm input-1 small-input" asp-items="ViewBag.SituacaoEfectivoId"></select>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="DataIngresso" class="control-label small-label"></label>
                    <input type="date" asp-for="DataIngresso" class="form-control form-control-sm input-1 small-input">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="TipoVinculo" class="control-label small-label"></label>
                    <select asp-for="TipoVinculo" class="form-select form-control-sm input-1 small-input">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Não Efectivo">Não Efectivo</option>
                    </select>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="Carreira" class="control-label small-label"></label>
                    <select asp-for="Carreira" class="form-select form-control-sm input-1 small-input">
                        <option value="Policial">Policial</option>
                        <option value="Cívil">Cívil</option>
                    </select>
                </div>
            </div>
            <div class="col-6 col-md-6">
                <div class="form-group">
                    <label asp-for="UnidadeOrigem" class="control-label small-label"></label>
                    <input type="text" asp-for="UnidadeOrigem" class="form-control form-control-sm input-1 small-input">
                </div>
            </div>
        </div>
        
    </div>

    <!-- 3 Academicos -->
    <div class="formbold-form-step-3">
        <div class="row">
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="Habilitacao" class="control-label small-label"></label>
                    <select asp-for="Habilitacao" class="form-select form-control-sm input-1 small-input">
                        <option value="Ensino Secundário">Ensino Secundário</option>
                        <option value="Médio Técnico">Médio Técnico</option>
                        <option value="Licenciado">Licenciado</option>
                        <option value="Mestrado">Mestrado</option>
                        <option value="Doutoramento">Doutoramento</option>
                    </select>
                    <span asp-validation-for="Habilitacao" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="CursoHabilitado" class="control-label small-label"></label>
                    <input type="text" asp-for="CursoHabilitado" class="form-control form-control-sm input-1 small-input" placeholder="Curso Habilitado" />
                    <span asp-validation-for="CursoHabilitado" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="InstitAcademica" class="control-label small-label"></label>
                    <input type="text" asp-for="InstitAcademica" class="form-control form-control-sm input-1 small-input" placeholder="Instituição Acadêmica" />
                    <span asp-validation-for="InstitAcademica" class="text-danger"></span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-md-12">
                <!-- Em Falta no Banco de Dados Outras Informações -->
                <div class="form-group">
                    <label class="control-label small-label" for="OutrasInfo">Outras Informações</label>
                    <textarea asp-for="OutrasInfo" id="OutrasInformacoes" class="form-control form-control-sm input-1 small-input"
                              placeholder="Outras informações do efectivo" rows="6"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- 4 Documentos -->
    <div class="formbold-form-step-4">
        <div class="row">
            <div class="col-6 col-md-4">
                <!-- Número de Documento -->
                <div class="form-group">
                    <label asp-for="NumBI" class="control-label small-label"></label>
                    <input asp-for="NumBI" class="form-control form-control-sm input-1 small-input" placeholder="Bilhete de Identidade" required />
                    <span asp-validation-for="NumBI" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <!-- Data de Emissão do Documento -->
                <div class="form-group">
                    <label class="control-label small-label">Data de Emissão</label>
                    <input asp-for="BIEmitido" class="form-control form-control-sm input-1 small-input" type="date" />
                    <span asp-validation-for="BIEmitido" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <!-- Data de Validade do Documento -->
                <div class="form-group">
                    <label class="control-label small-label">Data de Validade</label>
                    <input asp-for="BIValidade" class="form-control form-control-sm input-1 small-input" type="date" />
                    <span asp-validation-for="BIValidade" class="text-danger"></span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="NumCartaConducao" class="control-label small-label"></label>
                    <input asp-for="NumCartaConducao" class="form-control form-control-sm input-1 small-input" placeholder="Número da Carta de Condução" />
                    <span asp-validation-for="NumCartaConducao" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="CartaValidade" class="control-label small-label"></label>
                    <input type="date" asp-for="CartaValidade" class="form-control form-control-sm input-1 small-input" />
                    <span asp-validation-for="CartaValidade" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="CartaEmitido" class="control-label small-label"></label>
                    <input type="date" asp-for="CartaEmitido" class="form-control form-control-sm input-1 small-input" />
                    <span asp-validation-for="CartaEmitido" class="text-danger"></span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="NumPassaporte" class="control-label small-label"></label>
                    <input asp-for="NumPassaporte" class="form-control form-control-sm input-1 small-input" placeholder="Número do Passaporte" />
                    <span asp-validation-for="NumPassaporte" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="PassapValidade" class="control-label small-label"></label>
                    <input type="date" asp-for="PassapValidade" class="form-control form-control-sm input-1 small-input" />
                    <span asp-validation-for="PassapValidade" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="PassapEmitido" class="control-label small-label"></label>
                    <input type="date" asp-for="PassapEmitido" class="form-control form-control-sm input-1 small-input" />
                    <span asp-validation-for="PassapEmitido" class="text-danger"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- 5 Contactos -->
    <div class="formbold-form-step-5">
        <div class="row">
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <div class="form-group">
                        <label asp-for="ProvinciaResId" class="control-label small-label"></label>
                        <select asp-for="ProvinciaResId" class="form-select form-control-sm input-1 small-input" asp-items="ViewBag.ProvinciaResId"></select>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <div class="form-group">
                        <label asp-for="MunicipioId" class="control-label small-label"></label>
                        <select asp-for="MunicipioId" class="form-select form-control-sm input-1 small-input" asp-items="ViewBag.MunicipioId"></select>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="Destrito_BairroRes" class="control-label small-label"></label>
                    <input asp-for="Destrito_BairroRes" class="form-control form-control-sm input-1 small-input" placeholder="Bairro ou Destrito Residente" required />
                    <span asp-validation-for="Destrito_BairroRes" class="text-danger"></span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6 col-md-4">
                <div class="form-group">
                    <label asp-for="Rua" class="control-label small-label"></label>
                    <input asp-for="Rua" class="form-control form-control-sm input-1 small-input" placeholder="Rua ou Avenida" required />
                    <span asp-validation-for="Rua" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="form-group">
                    <label asp-for="CasaNum" class="control-label small-label"></label>
                    <input asp-for="CasaNum" class="form-control form-control-sm input-1 small-input" placeholder="Nº de Casa ou Apartamento" required />
                    <span asp-validation-for="CasaNum" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="Telefone1" class="control-label small-label"></label>
                    <input asp-for="Telefone1" class="form-control form-control-sm input-1 small-input" placeholder="Contacto principal" required />
                    <span asp-validation-for="Telefone1" class="text-danger"></span>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="form-group">
                    <label asp-for="Telefone2" class="control-label small-label"></label>
                    <input asp-for="Telefone2" class="form-control form-control-sm input-1 small-input" placeholder="Contacto alternativo" required />
                    <span asp-validation-for="Telefone2" class="text-danger"></span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-md-12">
                <div class="form-group">
                    <label asp-for="Email" class="control-label small-label"></label>
                    <input asp-for="Email" class="form-control form-control-sm input-1 small-input" placeholder="E-mail" required />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="formbold-form-btn-wrapper">
        <button class="formbold-back-btn custom2-btn btn-1" type="button">
            Voltar
        </button>

        <button class="formbold-btn custom2-btn btn-1" type="button">
            Próximo
        </button>
    </div>
</form>

<script>
    const stepMenuOne = document.querySelector('.formbold-step-menu1');
    const stepMenuTwo = document.querySelector('.formbold-step-menu2');
    const stepMenuThree = document.querySelector('.formbold-step-menu3');
    const stepMenuFour = document.querySelector('.formbold-step-menu4');
    const stepMenuFive = document.querySelector('.formbold-step-menu5');

    const stepOne = document.querySelector('.formbold-form-step-1');
    const stepTwo = document.querySelector('.formbold-form-step-2');
    const stepThree = document.querySelector('.formbold-form-step-3');
    const stepFour = document.querySelector('.formbold-form-step-4');
    const stepFive = document.querySelector('.formbold-form-step-5');

    const formSubmitBtn = document.querySelector('.formbold-btn');
    const formBackBtn = document.querySelector('.formbold-back-btn');
    const form = document.querySelector('form');

    formSubmitBtn.addEventListener("click", async function (event) {
        event.preventDefault();

        // Identifica qual passo está ativo no momento
        let currentStep;
        if (stepOne.classList.contains('active')) currentStep = stepOne;
        else if (stepTwo.classList.contains('active')) currentStep = stepTwo;
        else if (stepThree.classList.contains('active')) currentStep = stepThree;
        else if (stepFour.classList.contains('active')) currentStep = stepFour;
        else if (stepFive.classList.contains('active')) currentStep = stepFive;

        // Validação dos campos do passo atual
        const inputs = currentStep.querySelectorAll('input, select, textarea');
        let isValid = true;
        for (const input of inputs) {
            if (!input.checkValidity()) {
                input.reportValidity();
                isValid = false;
                break;
            }
        }

        if (!isValid) return;

        // Avançar ou Submeter
        if (stepOne.classList.contains('active')) {
            stepMenuOne.classList.remove('active');
            stepMenuTwo.classList.add('active');
            stepOne.classList.remove('active');
            stepTwo.classList.add('active');
            formBackBtn.classList.add('active');

        } else if (stepTwo.classList.contains('active')) {
            stepMenuTwo.classList.remove('active');
            stepMenuThree.classList.add('active');
            stepTwo.classList.remove('active');
            stepThree.classList.add('active');

        } else if (stepThree.classList.contains('active')) {
            stepMenuThree.classList.remove('active');
            stepMenuFour.classList.add('active');
            stepThree.classList.remove('active');
            stepFour.classList.add('active');

        } else if (stepFour.classList.contains('active')) {
            stepMenuFour.classList.remove('active');
            stepMenuFive.classList.add('active');
            stepFour.classList.remove('active');
            stepFive.classList.add('active');
            formSubmitBtn.textContent = 'Finalizar';

        } else if (stepFive.classList.contains('active')) {
            // SUBMISSÃO AJAX CORRIGIDA
            const formData = new FormData(form);

            // Pega o token do antiforgery se existir
            const tokenField = form.querySelector('input[name="__RequestVerificationToken"]');
            if (tokenField) {
                formData.append('__RequestVerificationToken', tokenField.value);
            }

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get("content-type");

                if (contentType && contentType.includes("application/json")) {
                    const result = await response.json();

                    if (result.success) {
                        alert("Efetivo cadastrado com sucesso!");
                        // Pode redirecionar, resetar ou fechar modal aqui
                    } else {
                        alert("Erro(s):\n" + result.errors.join("\n"));
                    }
                } else {
                    const text = await response.text(); // Exibe resposta em texto
                    console.error("Resposta inesperada:", text);
                    alert("Erro inesperado ao enviar o formulário.");
                }
            } catch (err) {
                alert("Erro ao enviar: " + err.message);
            }
        }
    });

    formBackBtn.addEventListener("click", function (event) {
        event.preventDefault();

        if (stepFive.classList.contains('active')) {
            stepMenuFive.classList.remove('active');
            stepMenuFour.classList.add('active');
            stepFive.classList.remove('active');
            stepFour.classList.add('active');
            formSubmitBtn.textContent = 'Próximo';

        } else if (stepFour.classList.contains('active')) {
            stepMenuFour.classList.remove('active');
            stepMenuThree.classList.add('active');
            stepFour.classList.remove('active');
            stepThree.classList.add('active');

        } else if (stepThree.classList.contains('active')) {
            stepMenuThree.classList.remove('active');
            stepMenuTwo.classList.add('active');
            stepThree.classList.remove('active');
            stepTwo.classList.add('active');

        } else if (stepTwo.classList.contains('active')) {
            stepMenuTwo.classList.remove('active');
            stepMenuOne.classList.add('active');
            stepTwo.classList.remove('active');
            stepOne.classList.add('active');
            formBackBtn.classList.remove('active');
        }
    });

    function previewImage(event) {
        const reader = new FileReader();
        reader.onload = function () {
            const output = document.getElementById('profileImage');
            output.src = reader.result;
        };
        reader.readAsDataURL(event.target.files[0]);
    }
</script>




@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
<link href="~/dist/css/form-step.css" rel="stylesheet" />
<link href="~/dist/css/botoes.css" rel="stylesheet" />





