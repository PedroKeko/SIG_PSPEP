@using SIG_PSPEP.Areas.Dpq.Models
@model CalendarPageModel
@{
    ViewData["Title"] = "Lançamento de Efectividade";
    var today = DateTime.Today;
    var currentMonth = today.Month;
    var currentYear = today.Year;
}

<link href="~/dist/css/mystyle.css" rel="stylesheet" />
<link href="~/dist/css/botoes.css" rel="stylesheet" />
<!-- Estilos para o calendário -->
<style>
    .calendar-container {
        max-width: 100%;
        margin: 0 auto;
    }

    .calendar-days-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-weight: bold;
        background-color: #f8f9fa;
        padding: 10px 0;
    }

    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-gap: 2px;
    }

    .calendar-day {
        height: 80px;
        border: 1px solid #dee2e6;
        padding: 5px;
        text-align: right;
        cursor: pointer;
        transition: background-color 0.2s;
    }

        .calendar-day:hover {
            background-color: #f1f1f1;
        }

    .today {
        background-color: #e6f7ff;
        font-size: 18px;
        font-weight: bold;
        animation: pulseHighlight 4s infinite;
        transition: transform 0.9s ease;
    }
    @@keyframes pulseHighlight {
        0%

    {
        box-shadow: 0 0 0px rgba(0, 123, 255, 0.5);
        transform: scale(1);
    }

    50% {
        box-shadow: 0 0 12px rgba(0, 123, 255, 0.8);
        transform: scale(1.05);
    }

    100% {
        box-shadow: 0 0 0px rgba(0, 123, 255, 0.5);
        transform: scale(1);
    }

    }

    .other-month {
        color: #000f43;
        background-color: #a5a4a4;
    }
</style>
<div class="container-fluid">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    <h2 class="text-center">Efetividade de @(new DateTime(currentYear, currentMonth, 1).ToString("MMMM yyyy"))</h2>

                    <div class="calendar-container mt-4">
                        <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
                            <button class="btn custom1-btn btn-1" id="prevMonth">&laquo; Mês Anterior</button>
                            <h4 id="currentMonthYear">@(new DateTime(currentYear, currentMonth, 1).ToString("MMMM yyyy"))</h4>
                            <button class="btn custom1-btn btn-1" id="nextMonth">Próximo Mês &raquo;</button>
                        </div>

                        <div class="calendar-grid">
                            <div class="calendar-days-header">
                                <div>Dom</div>
                                <div>Seg</div>
                                <div>Ter</div>
                                <div>Qua</div>
                                <div>Qui</div>
                                <div>Sex</div>
                                <div>Sáb</div>
                            </div>
                            <div id="calendarDays" class="calendar-days">
                                <!-- Os dias do calendário serão preenchidos via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para exibir a data selecionada -->
<div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dateModalLabel">Lançamento de Efectividade Multiplas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="modalFormContainer">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="submit" class="btn btn-primary" form="formLancamento">Salvar</button>
            </div>
        </div>
    </div>
</div>
<script src="~/dist/css/backend-bundle.min.js"></script>
<script src="~/dist/js/sweetalert2@11.js"></script>

<!-- Scripts para funcionalidades do calendário -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        // Inicializa o calendário
        generateCalendar(currentMonth, currentYear);

        // Navegar para o mês anterior
        document.getElementById('prevMonth').addEventListener('click', function () {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar(currentMonth, currentYear);
        });

        // Navegar para o mês seguinte
        document.getElementById('nextMonth').addEventListener('click', function () {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar(currentMonth, currentYear);
        });
    });

    // Gera o calendário para um determinado mês e ano
    function generateCalendar(month, year) {
        const calendarDays = document.getElementById('calendarDays');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        // Atualiza título
        currentMonthYear.textContent = `${monthNames[month]} ${year}`;

        // Limpa dias anteriores
        calendarDays.innerHTML = '';

        // Dados de datas
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const prevMonthDays = new Date(year, month, 0).getDate();

        let date = 1;
        let nextMonthDate = 1;

        for (let i = 0; i < 6; i++) { // Até 6 linhas
            for (let j = 0; j < 7; j++) { // 7 dias por semana
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';

                // Dias do mês anterior
                if (i === 0 && j < firstDay) {
                    const prevDate = prevMonthDays - (firstDay - j - 1);
                    const prevMonth = month === 0 ? 11 : month - 1;
                    const prevYear = month === 0 ? year - 1 : year;

                    dayCell.textContent = prevDate;
                    dayCell.classList.add('other-month');
                    dayCell.dataset.date = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(prevDate).padStart(2, '0')}`;
                }
                // Dias do próximo mês
                else if (date > daysInMonth) {
                    const nextMonth = month === 11 ? 0 : month + 1;
                    const nextYear = month === 11 ? year + 1 : year;

                    dayCell.textContent = nextMonthDate;
                    dayCell.classList.add('other-month');
                    dayCell.dataset.date = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(nextMonthDate).padStart(2, '0')}`;
                    nextMonthDate++;
                }
                // Dias do mês atual
                else {
                    const today = new Date();

                    dayCell.textContent = date;
                    if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        dayCell.classList.add('today'); // Destaca o dia atual
                    }

                    dayCell.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                    date++;
                }

                // Abre o modal ao clicar na data
                dayCell.addEventListener('click', function () {
                    const selectedDate = this.dataset.date;
                    openDateModal(selectedDate);
                });

                calendarDays.appendChild(dayCell);
            }
        }
    }

    // Abre o modal de lançamento com AJAX
     function openDateModal(dateString) {
        $.get(`/Dpq/Efectividades/SelecionarParaLancamento?data=${dateString}`, function (html) {
            // Injeta o conteúdo no corpo do modal
            $('#modalFormContainer').html(html);

            // Abre o modal com ID correto
            const modal = new bootstrap.Modal(document.getElementById('dateModal'));
            modal.show();

            // Inicializa o DataTable se a tabela existir
            if ($('#minhaTabela').length) {
                $('#minhaTabela').DataTable({
                    language: {
                        decimal: ",",
                        thousands: ".",
                        search: "",
                        lengthMenu: "_MENU_ registros por página",
                        info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
                        infoEmpty: "Nenhum registro disponível",
                        infoFiltered: "(filtrado de _MAX_ registros no total)",
                        zeroRecords: "Nenhum registro encontrado",
                        emptyTable: "Nenhum dado disponível",
                        paginate: {
                            first: "Primeiro",
                            previous: "Anterior",
                            next: "Próximo",
                            last: "Último"
                        }
                    },
                    initComplete: function () {
                        $('.dataTables_filter input').attr('placeholder', 'Buscar...');
                    }
                });
            }
        }).fail(function () {
            $('#modalFormContainer').html("<p class='text-danger'>Erro ao carregar o formulário.</p>");
        });
    }
</script>
