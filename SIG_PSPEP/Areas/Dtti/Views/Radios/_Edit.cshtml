@model SIG_PSPEP.Entidades.Radio

@{
    ViewData["Title"] = "Edit";
}

<style>
    .modal-content {
        max-height: 85vh;
        overflow-y: auto;
        border-radius: 10px;
    }

    .modal-header {
        background: rgb(0, 20, 60);
        background: linear-gradient(0deg, rgba(0, 20, 60, 1) 0%, rgba(5, 15, 120, 1) 100%);
        position: sticky;
        color: white;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
    }

        .modal-header .btn-close {
            filter: invert(1);
            opacity: 1;
        }

    .modal-title {
        font-size: 18px;
    }
</style>

<link rel="stylesheet" type="text/css" href="~/assets/libs/select2/dist/css/select2.min.css" />
<form asp-action="Edit" onsubmit="return submitForm(this)">
    <!-- Cabeçalho -->
    <div class="modal-header">
        <h5 class="modal-title">Atualizar Registo de Rádio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
    </div>

    <!-- Corpo -->
    <div class="modal-body">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="row g-3">
                    <div class="col-md-8">
                        <!-- Efectivo -->
                        <div class="form-group mb-1">
                            <label for="RadioTipoId" class="form-label small-label fw-semibold">Modelo de Rádio</label>
                            <select asp-for="RadioTipoId"
                                    asp-items="ViewBag.RadioTipoId"
                                    class="form-select select2"
                                    style="width: 100%;"
                                    required>
                                <option value="">-- Selecione o Modelo de Rádio --</option>
                            </select>
                            <span asp-validation-for="RadioTipoId" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-1">
                            <label class="form-label small-label fw-semibold">Estado Técnico</label>
                            <select asp-for="EstadoTecnico"
                                    asp-items="ViewBag.EstadoTecnicoList"
                                    class="form-select select2"
                                    style="width: 100%;"
                                    required>
                                <option value="">-- Selecione o estado técnico --</option>
                            </select>
                            <span asp-validation-for="EstadoTecnico" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
                <input type="hidden" asp-for="Id" />
                <!-- Linha com 3 colunas -->
                <div class="row g-3">
                    <!-- Coluna Esquerda -->
                    <div class="col-md-4">
                        <div class="form-group mb-1">
                            <label class="form-label small-label fw-semibold">ID de Rádio</label>
                            <input asp-for="IdRadio" class="form-control form-control-sm input-1 small-input" />
                            <span asp-validation-for="IdRadio" class="text-danger small"></span>
                        </div>
                    </div>
                    <!-- Coluna Central -->
                    <div class="col-md-4">
                        <div class="form-group mb-1">
                            <label asp-for="TEI" class="form-label small-label fw-semibold"></label>
                            <input asp-for="TEI" class="form-control form-control-sm input-1 small-input" />
                            <span asp-validation-for="TEI" class="text-danger small"></span>
                        </div>
                    </div>
                    <!-- Coluna Direita -->
                    <div class="col-md-4">
                        <div class="form-group mb-1">
                            <label class="form-label small-label fw-semibold">Nº de Série</label>
                            <input asp-for="NumSerie" class="form-control form-control-sm input-1 small-input" />
                            <span asp-validation-for="NumSerie" class="text-danger small"></span>
                        </div>
                    </div>
                </div> <!-- /row -->
            </div>
        </div>
    </div>

    <!-- Rodapé -->
    <div class="modal-footer d-flex flex-wrap justify-content-center align-items-center gap-3 p-3">
        <button type="submit"
                class="custom2-btn btn-2-success d-flex justify-content-center align-items-center px-4 py-2 text-center flex-grow-1 flex-sm-grow-0"
                style="min-width: 130px;">
            Criar
        </button>

        <button type="button"
                class="custom2-btn btn-2-dark-blue d-flex justify-content-center align-items-center px-4 py-2 text-center flex-grow-1 flex-sm-grow-0"
                data-bs-dismiss="modal"
                style="min-width: 130px;">
            Cancelar
        </button>
    </div>
</form>

<!-- Select2 CSS -->
<script src="~/assets/libs/select2/dist/js/select2.full.min.js"></script>
<script src="~/assets/libs/select2/dist/js/select2.min.js"></script>

<script>
    // Espera o DOM estar pronto
    $(document).ready(function () {
        // Quando qualquer modal for exibido
        $(document).on('shown.bs.modal', '.modal', function () {
            // Inicializa os elementos Select2 dentro do modal aberto
            $(this).find('.select2').each(function () {
                // Destroi instância anterior, se houver
                if ($(this).hasClass("select2-hidden-accessible")) {
                    $(this).select2('destroy');
                }

                // Inicializa novamente com dropdown dentro do modal
                $(this).select2({
                    dropdownParent: $(this).closest('.modal'),
                    width: '100%' // Garante largura total
                });
            });
        });
    });
</script>

<script>
    async function submitForm(form) {
        event.preventDefault();

        const formData = new FormData(form);

        try {
            const response = await fetch(form.action, {
                method: "POST",
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                // ✅ Sucesso: alerta SweetAlert2 bonito e central
                Swal.fire({
                    icon: 'success',
                    title: 'Sucesso!',
                    text: result.message || 'Rádio atualizado com sucesso.',
                    confirmButtonText: 'OK',
                    customClass: {
                        confirmButton: 'btn btn-success px-4'
                    },
                    buttonsStyling: false,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                }).then(() => {
                    // Fecha o modal sem recarregar a página inteira
                    const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
                    if (modal) modal.hide();

                    // Atualiza apenas a tabela/lista se necessário (Ajax opcional)
                    // Exemplo: $('#tabelaRadios').load('/Dtti/Radios #tabelaRadios');
                    location.reload(); // 🔄 Ou comenta esta linha se quiser evitar reload
                });
            } else {
                // ⚠️ Erro: mostra as mensagens no toast
                const mensagem = result.message || (result.errors ? result.errors.join('\n') : "Erro ao submeter o formulário.");

                Swal.fire({
                    icon: 'error',
                    title: 'Erro!',
                    text: mensagem,
                    toast: true,
                    position: 'top-end',
                    timer: 4000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                    customClass: { popup: 'colored-toast' }
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Erro inesperado!',
                text: 'Ocorreu um problema ao enviar o formulário.',
                toast: true,
                position: 'top-end',
                timer: 4000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }

        return false; // Evita o comportamento padrão do form
    }
</script>



